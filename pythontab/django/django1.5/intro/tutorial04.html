
<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<!-- Mirrored from docs.pythontab.com/django/django1.5/intro/tutorial04.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 04 Oct 2022 03:53:43 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>编写你的第一个 Django 程序 第4部分 &mdash; Django 中文手册 1.5 documentation</title>
  
  
  
    
  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  
  
   
  <script src="../_static/js/modernizr.min.js"></script>
</head>
<body class="wy-body-for-nav" role="document">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../contents.html" class="icon icon-home"> Django 中文手册
          

          
          </a>

          
            
            
              <div class="version">
                1.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="https://docs.pythontab.com/django/django1.5/search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../index-2.html">Django 中文文档</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">新手入门</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">初探 Django</a></li>
<li class="toctree-l2"><a class="reference internal" href="install.html">快速安装指南</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial01.html">编写你的第一个 Django 程序 第1部分</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial02.html">编写你的第一个 Django 程序 第2部分</a></li>
<li class="toctree-l2"><a class="reference internal" href="tutorial03.html">编写你的第一个 Django 程序 第3部分</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">编写你的第一个 Django 程序 第4部分</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id1">编写一个简单的窗体</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id2">使用通用视图：优化代码</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#urlconf">修改 URLconf</a></li>
<li class="toctree-l4"><a class="reference internal" href="#views">修改 views</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="tutorial05.html">编写你的第一个 Django 程序 第5部分</a></li>
<li class="toctree-l2"><a class="reference internal" href="reusable-apps.html">进阶教程：如何编写可重用的应用程序</a></li>
<li class="toctree-l2"><a class="reference internal" href="whatsnext.html">下一步阅读什么</a></li>
<li class="toctree-l2"><a class="reference internal" href="contributing.html">为Django编写属于你的首个补丁</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../topics/index.html">使用 Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="../howto/index.html">&#8220;How-to&#8221; guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq/index.html">Django FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ref/index.html">API 参考</a></li>
<li class="toctree-l1"><a class="reference internal" href="../misc/index.html">Meta-documentation and miscellany</a></li>
<li class="toctree-l1"><a class="reference internal" href="../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releases/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../internals/index.html">Django internals</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../contents.html">Django 中文手册</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../contents.html"> &mdash; Django 中文手册 1.5 documentation</a> &raquo;</li>
      
          <li><a href="index.html">新手入门</a> &raquo;</li>
      
    <li>编写你的第一个 Django 程序 第4部分</li>
      <li class="wy-breadcrumbs-aside">
        
            <a href="../../../index.html" class="fa fa-github"> 在线手册中心</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="django-4">
<h1>编写你的第一个 Django 程序 第4部分<a class="headerlink" href="#django-4" title="Permalink to this headline">¶</a></h1>
<p>本教程上接 <a class="reference internal" href="tutorial03.html"><em>教程 第3部分</em></a> 。我们将
继续开发 Web-poll 应用并且关注在处理简单的窗体和优化我们的代码。</p>
<div class="section" id="id1">
<h2>编写一个简单的窗体<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>让我们把在上一篇教程中编写的 poll 的 detail 模板更新下，在模板中包含 HTML 的 <code class="docutils literal"><span class="pre">&lt;form&gt;</span></code>
组件:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">poll.question</span> <span class="cp">}}</span><span class="nt">&lt;/h1&gt;</span>

<span class="cp">{%</span> <span class="k">if</span> <span class="nv">error_message</span> <span class="cp">%}</span><span class="nt">&lt;p&gt;&lt;strong&gt;</span><span class="cp">{{</span> <span class="nv">error_message</span> <span class="cp">}}</span><span class="nt">&lt;/strong&gt;&lt;/p&gt;</span><span class="cp">{%</span> <span class="k">endif</span> <span class="cp">%}</span>

<span class="nt">&lt;form</span> <span class="na">action=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;polls:vote&#39;</span> <span class="nv">poll.id</span> <span class="cp">%}</span><span class="s">&quot;</span> <span class="na">method=</span><span class="s">&quot;post&quot;</span><span class="nt">&gt;</span>
<span class="cp">{%</span> <span class="k">csrf_token</span> <span class="cp">%}</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">choice</span> <span class="k">in</span> <span class="nv">poll.choice_set.all</span> <span class="cp">%}</span>
    <span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;radio&quot;</span> <span class="na">name=</span><span class="s">&quot;choice&quot;</span> <span class="na">id=</span><span class="s">&quot;choice</span><span class="cp">{{</span> <span class="nb">forloop</span><span class="nv">.counter</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="na">value=</span><span class="s">&quot;</span><span class="cp">{{</span> <span class="nv">choice.id</span> <span class="cp">}}</span><span class="s">&quot;</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;label</span> <span class="na">for=</span><span class="s">&quot;choice</span><span class="cp">{{</span> <span class="nb">forloop</span><span class="nv">.counter</span> <span class="cp">}}</span><span class="s">&quot;</span><span class="nt">&gt;</span><span class="cp">{{</span> <span class="nv">choice.choice_text</span> <span class="cp">}}</span><span class="nt">&lt;/label&gt;&lt;br</span> <span class="nt">/&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="nt">&lt;input</span> <span class="na">type=</span><span class="s">&quot;submit&quot;</span> <span class="na">value=</span><span class="s">&quot;Vote&quot;</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/form&gt;</span>
</pre></div>
</div>
<p>简单的总结下:</p>
<ul class="simple">
<li>上面的模板中为每个投票选项设置了一个单选按钮。每个单选按钮的
<code class="docutils literal"><span class="pre">value</span></code> 是投票选项对应的 ID 。每个单选按钮的
<code class="docutils literal"><span class="pre">name</span></code> 都是 <code class="docutils literal"><span class="pre">&quot;choice&quot;</span></code>。这意味着，当有人选择了一个单选按钮并提交了表单，将会发送
的 POST 数据是 <code class="docutils literal"><span class="pre">choice=3</span></code>。这是 HTML 表单中的基本概念。</li>
<li>我们将 form 的 <code class="docutils literal"><span class="pre">action</span></code> 设置为 <code class="docutils literal"><span class="pre">{%</span> <span class="pre">url</span> <span class="pre">'polls:vote'</span> <span class="pre">poll.id</span> <span class="pre">%}</span></code>，以及设置了
<code class="docutils literal"><span class="pre">method=&quot;post&quot;</span></code> 。使用 <code class="docutils literal"><span class="pre">method=&quot;post&quot;</span></code> ( 而不是 <code class="docutils literal"><span class="pre">method=&quot;get&quot;</span></code>) 是非常重要的，因为这种提交表单的方式会改变服务器端的数据。
当你创建一个表单为了修改服务器端的数据时，请使用
<code class="docutils literal"><span class="pre">method=&quot;post&quot;</span></code> 。这不是 Django 特定的技巧；这是优秀的 Web 开发实践。</li>
<li><code class="docutils literal"><span class="pre">forloop.counter</span></code> 表示 <a class="reference internal" href="../ref/templates/builtins.html#std:templatetag-for"><code class="xref std std-ttag docutils literal"><span class="pre">for</span></code></a> 标签在循环中已经循环过的次数</li>
<li>由于我们要创建一个POST form ( 具有修改数据的功能
)，我们需要担心跨站点请求伪造 （ Cross Site Request Forgeries ）。
值得庆幸的是，你不必太担心这一点，因为 Django 自带了一个非常容易使用的系统来防御它。
总之，所有的 POST form 针对内部的 URLs 时都应该使用
<a class="reference internal" href="../ref/templates/builtins.html#std:templatetag-csrf_token"><code class="xref std std-ttag docutils literal"><span class="pre">{%</span> <span class="pre">csrf_token</span> <span class="pre">%}</span></code></a> 模板标签。</li>
</ul>
<p>现在，让我们来创建一个 Django 视图来处理提交的数据。
记得吗？在 <a class="reference internal" href="tutorial03.html"><em>教程 第3部分</em></a> 中，我们为 polls 应用创建了一个
URLconf 配置中包含有这一行代码:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">url</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;poll_id&gt;\d+)/vote/$&#39;</span><span class="p">,</span> <span class="n">views</span><span class="o">.</span><span class="n">vote</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;vote&#39;</span><span class="p">),</span>
</pre></div>
</div>
<p>我们还创建了一个虚拟实现的 <code class="docutils literal"><span class="pre">vote()</span></code> 函数。让我们创建一个真实版本吧。在
<code class="docutils literal"><span class="pre">polls/views.py</span></code> 中添加如下代码:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.shortcuts</span> <span class="kn">import</span> <span class="n">get_object_or_404</span><span class="p">,</span> <span class="n">render</span>
<span class="kn">from</span> <span class="nn">django.http</span> <span class="kn">import</span> <span class="n">HttpResponseRedirect</span><span class="p">,</span> <span class="n">HttpResponse</span>
<span class="kn">from</span> <span class="nn">django.core.urlresolvers</span> <span class="kn">import</span> <span class="n">reverse</span>
<span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Choice</span><span class="p">,</span> <span class="n">Poll</span>
<span class="c"># ...</span>
<span class="k">def</span> <span class="nf">vote</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">poll_id</span><span class="p">):</span>
    <span class="n">p</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Poll</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">poll_id</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">selected_choice</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">choice_set</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pk</span><span class="o">=</span><span class="n">request</span><span class="o">.</span><span class="n">POST</span><span class="p">[</span><span class="s">&#39;choice&#39;</span><span class="p">])</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">KeyError</span><span class="p">,</span> <span class="n">Choice</span><span class="o">.</span><span class="n">DoesNotExist</span><span class="p">):</span>
        <span class="c"># Redisplay the poll voting form.</span>
        <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;polls/detail.html&#39;</span><span class="p">,</span> <span class="p">{</span>
            <span class="s">&#39;poll&#39;</span><span class="p">:</span> <span class="n">p</span><span class="p">,</span>
            <span class="s">&#39;error_message&#39;</span><span class="p">:</span> <span class="s">&quot;You didn&#39;t select a choice.&quot;</span><span class="p">,</span>
        <span class="p">})</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">votes</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">selected_choice</span><span class="o">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c"># Always return an HttpResponseRedirect after successfully dealing</span>
        <span class="c"># with POST data. This prevents data from being posted twice if a</span>
        <span class="c"># user hits the Back button.</span>
        <span class="k">return</span> <span class="n">HttpResponseRedirect</span><span class="p">(</span><span class="n">reverse</span><span class="p">(</span><span class="s">&#39;polls:results&#39;</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">id</span><span class="p">,)))</span>
</pre></div>
</div>
<p>在这代码中有些内容还未在本教程中提到过:</p>
<ul>
<li><p class="first"><a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal"><span class="pre">request.POST</span></code></a> 是一个类似字典的对象，可以让你
通过关键字名称来获取提交的数据。在本例中，
<code class="docutils literal"><span class="pre">request.POST['choice']</span></code> 返回了所选择的投票项目的 ID ，以字符串的形式。
<a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal"><span class="pre">request.POST</span></code></a> 的值永远是字符串形式的。</p>
<p>请注意 Django 也同样的提供了通过 <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest.GET" title="django.http.HttpRequest.GET"><code class="xref py py-attr docutils literal"><span class="pre">request.GET</span></code></a> 获取 GET 数据的方法 &#8211;
但是在代码中我们明确的使用了 <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest.POST" title="django.http.HttpRequest.POST"><code class="xref py py-attr docutils literal"><span class="pre">request.POST</span></code></a> 方法，以确保数据是通过 POST 方法来修改的。</p>
</li>
<li><p class="first">如果 <code class="docutils literal"><span class="pre">choice</span></code> 未在 POST 数据中提供 <code class="docutils literal"><span class="pre">request.POST['choice']</span></code> 将抛出 <a class="reference external" href="http://docs.python.org/2.7/library/exceptions.html#exceptions.KeyError" title="(in Python v2.7)"><code class="xref py py-exc docutils literal"><span class="pre">KeyError</span></code></a>
当未给定 <code class="docutils literal"><span class="pre">choice</span></code> 对象时上面的代码若检测到抛出的是
<a class="reference external" href="http://docs.python.org/2.7/library/exceptions.html#exceptions.KeyError" title="(in Python v2.7)"><code class="xref py py-exc docutils literal"><span class="pre">KeyError</span></code></a> 异常就会向 poll 显示一条错误信息。</p>
</li>
<li><p class="first">在增加了投票选项的统计数后，代码返回一个
<a class="reference internal" href="../ref/request-response.html#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal"><span class="pre">HttpResponseRedirect</span></code></a> 对象而不是常见的
<a class="reference internal" href="../ref/request-response.html#django.http.HttpResponse" title="django.http.HttpResponse"><code class="xref py py-class docutils literal"><span class="pre">HttpResponse</span></code></a> 对象。
<a class="reference internal" href="../ref/request-response.html#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal"><span class="pre">HttpResponseRedirect</span></code></a> 对象需要一个参数：用户将被重定向的 URL
(请继续看下去在这情况下我们是如何构造 URL ) 。</p>
<p>就像上面用 Python 作的注释那样，当成功的处理了 POST 数据后你应该总是返回一个
<a class="reference internal" href="../ref/request-response.html#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal"><span class="pre">HttpResponseRedirect</span></code></a> 对象。
这个技巧不是特定于 Django 的；它是优秀的 Web 开发实践。</p>
</li>
<li><p class="first">在本例中，我们在 <a class="reference internal" href="../ref/request-response.html#django.http.HttpResponseRedirect" title="django.http.HttpResponseRedirect"><code class="xref py py-class docutils literal"><span class="pre">HttpResponseRedirect</span></code></a> 的构造方法中使用了 <a class="reference internal" href="../ref/urlresolvers.html#django.core.urlresolvers.reverse" title="django.core.urlresolvers.reverse"><code class="xref py py-func docutils literal"><span class="pre">reverse()</span></code></a> 函数。
此函数有助于避免在视图中硬编码 URL 的功能。它指定了我们想要的跳转的视图函数名以及视图函数中
URL 模式相应的可变参数。在本例中，我们使用了教程 第3部分中的 URLconf 配置，
<a class="reference internal" href="../ref/urlresolvers.html#django.core.urlresolvers.reverse" title="django.core.urlresolvers.reverse"><code class="xref py py-func docutils literal"><span class="pre">reverse()</span></code></a> 将会返回类似如下所示的字符串</p>
<div class="highlight-python"><div class="highlight"><pre><span class="s">&#39;/polls/3/results/&#39;</span>
</pre></div>
</div>
<p>... 在此 <code class="docutils literal"><span class="pre">3</span></code> 就是 <code class="docutils literal"><span class="pre">p.id</span></code> 的值。该重定向 URL 会调用
<code class="docutils literal"><span class="pre">'results'</span></code> 视图并显示最终页面。</p>
</li>
</ul>
<p>正如在教程 第3部分提到的，<code class="docutils literal"><span class="pre">request</span></code> 是一个 <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal"><span class="pre">HttpRequest</span></code></a>
对象。想了解 <a class="reference internal" href="../ref/request-response.html#django.http.HttpRequest" title="django.http.HttpRequest"><code class="xref py py-class docutils literal"><span class="pre">HttpRequest</span></code></a> 对象更多的内容，请参阅
<a class="reference internal" href="../ref/request-response.html"><em>request 和 response 文档</em></a> 。</p>
<p>当有人投票后，<code class="docutils literal"><span class="pre">vote()</span></code> 视图会重定向到投票结果页。让我们来编写这个视图</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">results</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">poll_id</span><span class="p">):</span>
    <span class="n">poll</span> <span class="o">=</span> <span class="n">get_object_or_404</span><span class="p">(</span><span class="n">Poll</span><span class="p">,</span> <span class="n">pk</span><span class="o">=</span><span class="n">poll_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">render</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s">&#39;polls/results.html&#39;</span><span class="p">,</span> <span class="p">{</span><span class="s">&#39;poll&#39;</span><span class="p">:</span> <span class="n">poll</span><span class="p">})</span>
</pre></div>
</div>
<p>这几乎和 <a class="reference internal" href="tutorial03.html"><em>教程 第3部分</em></a> 中的 <code class="docutils literal"><span class="pre">detail()</span></code> 视图完全一样。
唯一的区别就是模板名称。 稍后我们会解决这个冗余问题。</p>
<p>现在，创建一个 <code class="docutils literal"><span class="pre">polls/results.html</span></code> 模板:</p>
<div class="highlight-html+django"><div class="highlight"><pre><span class="nt">&lt;h1&gt;</span><span class="cp">{{</span> <span class="nv">poll.question</span> <span class="cp">}}</span><span class="nt">&lt;/h1&gt;</span>

<span class="nt">&lt;ul&gt;</span>
<span class="cp">{%</span> <span class="k">for</span> <span class="nv">choice</span> <span class="k">in</span> <span class="nv">poll.choice_set.all</span> <span class="cp">%}</span>
    <span class="nt">&lt;li&gt;</span><span class="cp">{{</span> <span class="nv">choice.choice_text</span> <span class="cp">}}</span> -- <span class="cp">{{</span> <span class="nv">choice.votes</span> <span class="cp">}}</span> vote<span class="cp">{{</span> <span class="nv">choice.votes</span><span class="o">|</span><span class="nf">pluralize</span> <span class="cp">}}</span><span class="nt">&lt;/li&gt;</span>
<span class="cp">{%</span> <span class="k">endfor</span> <span class="cp">%}</span>
<span class="nt">&lt;/ul&gt;</span>

<span class="nt">&lt;a</span> <span class="na">href=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">url</span> <span class="s1">&#39;polls:detail&#39;</span> <span class="nv">poll.id</span> <span class="cp">%}</span><span class="s">&quot;</span><span class="nt">&gt;</span>Vote again?<span class="nt">&lt;/a&gt;</span>
</pre></div>
</div>
<p>现在，在浏览器中访问 <code class="docutils literal"><span class="pre">/polls/1/</span></code> 并完成投票。每次投票后你将会看到结果页数据都有更新。
如果你没有选择投票选项就提交了，将会看到错误的信息。</p>
</div>
<div class="section" id="id2">
<h2>使用通用视图：优化代码<a class="headerlink" href="#id2" title="Permalink to this headline">¶</a></h2>
<p><code class="docutils literal"><span class="pre">detail()</span></code> ( 在 <a class="reference internal" href="tutorial03.html"><em>教程 第3部分</em></a> 中) 和 <code class="docutils literal"><span class="pre">results()</span></code> 视图
都很简单 &#8211; 并且还有上面所提到的冗余问题。<code class="docutils literal"><span class="pre">index()</span></code>
用于显示 polls 列表的 <code class="docutils literal"><span class="pre">index()</span></code> 视图 (也在教程 第3部分中)，也是存在类似的问题。</p>
<p>这些视图代表了基本的 Web 开发中一种常见的问题：
根据 URL 中的参数从数据库中获取数据，加载模板并返回渲染后的内容。由于这类现象很
常见，因此 Django 提供了一种快捷方式，被称之为“通用视图”系统。</p>
<p>通用视图抽象了常见的模式，以至于你不需要编写 Python 代码来编写一个应用。</p>
<p>让我们把 poll 应用修改成使用通用视图系统的应用，这样我们就能删除删除一些我们自己的代码了。
我们将采取以下步骤来进行修改：</p>
<ol class="arabic simple">
<li>修改 URLconf 。</li>
<li>删除一些旧的，不必要的视图。</li>
<li>修正 URL 处理到对应的新视图。</li>
</ol>
<p>请继续阅读了解详细的信息。</p>
<div class="admonition- admonition">
<p class="first admonition-title">为什么要重构代码？</p>
<p>通常情况下，当你编写一个 Django 应用时，你会评估下通用视图是否适合解决你的问题，
如果适合你就应该从一开始就使用它，而不是进行到一半才重构你的代码。
但是本教程直到现在都故意集中介绍“硬编码”视图，是为了专注于核心概念上。</p>
<p class="last">就像你在使用计算器前需要知道基本的数学知识一样。</p>
</div>
<div class="section" id="urlconf">
<h3>修改 URLconf<a class="headerlink" href="#urlconf" title="Permalink to this headline">¶</a></h3>
<p>首先，打开 <code class="docutils literal"><span class="pre">polls/urls.py</span></code> 的 URLconf 配置文件并修改成如下所示样子</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django.conf.urls</span> <span class="kn">import</span> <span class="n">patterns</span><span class="p">,</span> <span class="n">url</span>
<span class="kn">from</span> <span class="nn">django.views.generic</span> <span class="kn">import</span> <span class="n">DetailView</span><span class="p">,</span> <span class="n">ListView</span>
<span class="kn">from</span> <span class="nn">polls.models</span> <span class="kn">import</span> <span class="n">Poll</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="n">patterns</span><span class="p">(</span><span class="s">&#39;&#39;</span><span class="p">,</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^$&#39;</span><span class="p">,</span>
        <span class="n">ListView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
            <span class="n">queryset</span><span class="o">=</span><span class="n">Poll</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s">&#39;-pub_date&#39;</span><span class="p">)[:</span><span class="mi">5</span><span class="p">],</span>
            <span class="n">context_object_name</span><span class="o">=</span><span class="s">&#39;latest_poll_list&#39;</span><span class="p">,</span>
            <span class="n">template_name</span><span class="o">=</span><span class="s">&#39;polls/index.html&#39;</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s">&#39;index&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;pk&gt;\d+)/$&#39;</span><span class="p">,</span>
        <span class="n">DetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">Poll</span><span class="p">,</span>
            <span class="n">template_name</span><span class="o">=</span><span class="s">&#39;polls/detail.html&#39;</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s">&#39;detail&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;pk&gt;\d+)/results/$&#39;</span><span class="p">,</span>
        <span class="n">DetailView</span><span class="o">.</span><span class="n">as_view</span><span class="p">(</span>
            <span class="n">model</span><span class="o">=</span><span class="n">Poll</span><span class="p">,</span>
            <span class="n">template_name</span><span class="o">=</span><span class="s">&#39;polls/results.html&#39;</span><span class="p">),</span>
        <span class="n">name</span><span class="o">=</span><span class="s">&#39;results&#39;</span><span class="p">),</span>
    <span class="n">url</span><span class="p">(</span><span class="s">r&#39;^(?P&lt;poll_id&gt;\d+)/vote/$&#39;</span><span class="p">,</span> <span class="s">&#39;polls.views.vote&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s">&#39;vote&#39;</span><span class="p">),</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="views">
<h3>修改 views<a class="headerlink" href="#views" title="Permalink to this headline">¶</a></h3>
<p>在这我们将使用两个通用视图：
<a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.list.ListView" title="django.views.generic.list.ListView"><code class="xref py py-class docutils literal"><span class="pre">ListView</span></code></a> 和
<a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal"><span class="pre">DetailView</span></code></a> 。这两个视图分别用于显示两种抽象概念
“显示一系列对象的列表” 和
“显示一个特定类型的对象的详细信息页”。</p>
<ul class="simple">
<li>每个视图都需要知道使用哪个模型数据。因此需要提供将要使用的 <code class="docutils literal"><span class="pre">model</span></code> 参数。</li>
<li><a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal"><span class="pre">DetailView</span></code></a> 通用视图期望从 URL 中捕获名为 <code class="docutils literal"><span class="pre">&quot;pk&quot;</span></code>
的主键值，因此我们将 <code class="docutils literal"><span class="pre">poll_id</span></code> 改为 <code class="docutils literal"><span class="pre">pk</span></code> 。</li>
</ul>
<p>默认情况下， <a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal"><span class="pre">DetailView</span></code></a> 通用视图使用名为
<code class="docutils literal"><span class="pre">&lt;应用名&gt;/&lt;模型名&gt;_detail.html</span></code> 的模板。在我们的例子中，将使用名为 <code class="docutils literal"><span class="pre">&quot;polls/poll_detail.html&quot;</span></code> 的模板。
<code class="docutils literal"><span class="pre">template_name</span></code> 参数是告诉 Django 使用指定的模板名，而不是使用自动生成的默认模板名。
我们也指定了 <code class="docutils literal"><span class="pre">results</span></code> 列表视图的 <code class="docutils literal"><span class="pre">template_name</span></code> &#8211;
这确保了 results 视图和 detail 视图渲染时会有不同的外观，虽然它们有一个
<a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.detail.DetailView" title="django.views.generic.detail.DetailView"><code class="xref py py-class docutils literal"><span class="pre">DetailView</span></code></a> 隐藏在幕后。</p>
<p>同样的，<a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.list.ListView" title="django.views.generic.list.ListView"><code class="xref py py-class docutils literal"><span class="pre">ListView</span></code></a> 通用视图使用的默认模板名为
<code class="docutils literal"><span class="pre">&lt;应用名&gt;/&lt;模型名&gt;_list.html</span></code> ；我们指定了 <code class="docutils literal"><span class="pre">template_name</span></code> 参数告诉
<a class="reference internal" href="../ref/class-based-views/generic-display.html#django.views.generic.list.ListView" title="django.views.generic.list.ListView"><code class="xref py py-class docutils literal"><span class="pre">ListView</span></code></a> 使用已经存在的
<code class="docutils literal"><span class="pre">&quot;polls/index.html&quot;</span></code> 模板。</p>
<p>在之前的教程中，模板提供的上下文中包含了 <code class="docutils literal"><span class="pre">poll</span></code> 和 <code class="docutils literal"><span class="pre">latest_poll_list</span></code>
上下文变量。在 <code class="docutils literal"><span class="pre">DetailView</span></code> 中 <code class="docutils literal"><span class="pre">poll</span></code> 变量是自动提供的
&#8211; 因为我们使用了一个 Django 模型 (<code class="docutils literal"><span class="pre">Poll</span></code>) ，Django
能够为上下文变量确定适合的名称。
另外 ListView 自动生成的上下文变量名是
<code class="docutils literal"><span class="pre">poll_list</span></code> 。若要覆盖此变量我们需要提供 <code class="docutils literal"><span class="pre">context_object_name</span></code> 选项，
我们想要使用 <code class="docutils literal"><span class="pre">latest_poll_list</span></code> 来替代它。作为一种替代方式，你可以改变你的模板来
匹配新的默认的上下文变量 &#8211; 但它是一个非常容易地告诉 Django 使用你想要的变量的方式。</p>
<p>现在你可以在 <code class="docutils literal"><span class="pre">polls/views.py</span></code> 中删除 <code class="docutils literal"><span class="pre">index()</span></code> ， <code class="docutils literal"><span class="pre">detail()</span></code> 和 <code class="docutils literal"><span class="pre">results()</span></code> 视图了。
我们不需要它们了 &#8211; 它们已替换为通用视图了。你也可以删除不再需要的 <code class="docutils literal"><span class="pre">HttpResponse</span></code> 导入包了。</p>
<p>运行服务器，并且使用下基于通用视图的新投票应用。</p>
<p>有关通用视图的完整详细信息，请参阅 <a class="reference internal" href="../topics/class-based-views/index.html"><em>通用视图文档</em></a>.</p>
<p>当你熟悉了窗体和通用视图后，请阅读 <a class="reference internal" href="tutorial05.html"><em>教程 第5部分</em></a> 来学习测试我们的投票应用。</p>
</div>
</div>
</div>


           </div>
          </div>
	<hr/>
	<div>
		<p>扫码关注，获取更多内容</p>
		<img src="../../../statics/img/qrcode.jpg" width="100" height="100" />
	</div>
	<!-- duoshuo start -->
	<div class="ds-thread"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"pytabdocs"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = '../../../statics/js/duoshuo.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] 
			 || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
	</script>
	<!-- duoshuo end -->
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="tutorial05.html" class="btn btn-neutral float-right" title="编写你的第一个 Django 程序 第5部分" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="tutorial03.html" class="btn btn-neutral" title="编写你的第一个 Django 程序 第3部分" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Django Software Foundation and contributors.
      Last updated on Oct 24, 2016.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.5',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   
  <script type="text/javascript" src="../../../static/js/global.html" ></script>
  <script type="text/javascript">
        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
        document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F141f4ed9eb11f462fa19fdd960639134' type='text/javascript'%3E%3C/script%3E"));
  </script>
</body>

<!-- Mirrored from docs.pythontab.com/django/django1.5/intro/tutorial04.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 04 Oct 2022 03:53:43 GMT -->
</html>