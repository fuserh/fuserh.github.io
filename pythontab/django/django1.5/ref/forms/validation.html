
<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<!-- Mirrored from docs.pythontab.com/django/django1.5/ref/forms/validation.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 04 Oct 2022 03:53:51 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Form and field validation &mdash; Django 中文手册 1.5 documentation</title>
  
  
  
    
  
  
    <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  
  
   
  <script src="../../_static/js/modernizr.min.js"></script>
</head>
<body class="wy-body-for-nav" role="document">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../contents.html" class="icon icon-home"> Django 中文手册
          

          
          </a>

          
            
            
              <div class="version">
                1.5
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="https://docs.pythontab.com/django/django1.5/search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../../index-2.html">Django 中文文档</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../intro/index.html">新手入门</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../topics/index.html">使用 Django</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../howto/index.html">&#8220;How-to&#8221; guides</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../faq/index.html">Django FAQ</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">API 参考</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../class-based-views/index.html">Class-based views</a></li>
<li class="toctree-l2"><a class="reference internal" href="../clickjacking.html">Clickjacking Protection</a></li>
<li class="toctree-l2"><a class="reference internal" href="../contrib/index.html"><code class="docutils literal"><span class="pre">contrib</span></code> packages</a></li>
<li class="toctree-l2"><a class="reference internal" href="../databases.html">Databases</a></li>
<li class="toctree-l2"><a class="reference internal" href="../django-admin.html">django-admin.py and manage.py</a></li>
<li class="toctree-l2"><a class="reference internal" href="../django-admin.html#running-management-commands-from-your-code">Running management commands from your code</a></li>
<li class="toctree-l2"><a class="reference internal" href="../exceptions.html">Django 异常</a></li>
<li class="toctree-l2"><a class="reference internal" href="../files/index.html">File handling</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html">Forms</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="api.html">The Forms API</a></li>
<li class="toctree-l3"><a class="reference internal" href="fields.html">Form fields</a></li>
<li class="toctree-l3"><a class="reference internal" href="models.html">Model Form Functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="widgets.html">Widgets</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Form and field validation</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#form-subclasses-and-modifying-field-errors">Form subclasses and modifying field errors</a></li>
<li class="toctree-l4"><a class="reference internal" href="#using-validation-in-practice">Using validation in practice</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../middleware.html">Middleware</a></li>
<li class="toctree-l2"><a class="reference internal" href="../models/index.html">Models</a></li>
<li class="toctree-l2"><a class="reference internal" href="../request-response.html">Request and response objects</a></li>
<li class="toctree-l2"><a class="reference internal" href="../template-response.html">TemplateResponse and SimpleTemplateResponse</a></li>
<li class="toctree-l2"><a class="reference internal" href="../settings.html">Settings</a></li>
<li class="toctree-l2"><a class="reference internal" href="../signals.html">Signals</a></li>
<li class="toctree-l2"><a class="reference internal" href="../templates/index.html">Templates</a></li>
<li class="toctree-l2"><a class="reference internal" href="../unicode.html">Unicode data</a></li>
<li class="toctree-l2"><a class="reference internal" href="../urlresolvers.html"><code class="docutils literal"><span class="pre">django.core.urlresolvers</span></code> utility functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../urls.html"><code class="docutils literal"><span class="pre">django.conf.urls</span></code> utility functions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../utils.html">Django Utils</a></li>
<li class="toctree-l2"><a class="reference internal" href="../validators.html">Validators</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../misc/index.html">Meta-documentation and miscellany</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releases/index.html">Release notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../internals/index.html">Django internals</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../../contents.html">Django 中文手册</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../../contents.html"> &mdash; Django 中文手册 1.5 documentation</a> &raquo;</li>
      
          <li><a href="../index.html">API 参考</a> &raquo;</li>
      
          <li><a href="index.html">Forms</a> &raquo;</li>
      
    <li>Form and field validation</li>
      <li class="wy-breadcrumbs-aside">
        
            <a href="../../../../index.html" class="fa fa-github"> 在线手册中心</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="form-and-field-validation">
<span id="id1"></span><h1>Form and field validation<a class="headerlink" href="#form-and-field-validation" title="Permalink to this headline">¶</a></h1>
<p>Form validation happens when the data is cleaned. If you want to customize
this process, there are various places you can change, each one serving a
different purpose. Three types of cleaning methods are run during form
processing. These are normally executed when you call the <code class="docutils literal"><span class="pre">is_valid()</span></code>
method on a form. There are other things that can trigger cleaning and
validation (accessing the <code class="docutils literal"><span class="pre">errors</span></code> attribute or calling <code class="docutils literal"><span class="pre">full_clean()</span></code>
directly), but normally they won&#8217;t be needed.</p>
<p>In general, any cleaning method can raise <code class="docutils literal"><span class="pre">ValidationError</span></code> if there is a
problem with the data it is processing, passing the relevant error message to
the <code class="docutils literal"><span class="pre">ValidationError</span></code> constructor. If no <code class="docutils literal"><span class="pre">ValidationError</span></code> is raised, the
method should return the cleaned (normalized) data as a Python object.</p>
<p>If you detect multiple errors during a cleaning method and wish to signal all
of them to the form submitter, it is possible to pass a list of errors to the
<code class="docutils literal"><span class="pre">ValidationError</span></code> constructor.</p>
<p>Most validation can be done using <a class="reference internal" href="#validators">validators</a> - simple helpers that can be
reused easily. Validators are simple functions (or callables) that take a single
argument and raise <code class="docutils literal"><span class="pre">ValidationError</span></code> on invalid input. Validators are run
after the field&#8217;s <code class="docutils literal"><span class="pre">to_python</span></code> and <code class="docutils literal"><span class="pre">validate</span></code> methods have been called.</p>
<p>Validation of a Form is split into several steps, which can be customized or
overridden:</p>
<ul>
<li><p class="first">The <code class="docutils literal"><span class="pre">to_python()</span></code> method on a Field is the first step in every
validation. It coerces the value to correct datatype and raises
<code class="docutils literal"><span class="pre">ValidationError</span></code> if that is not possible. This method accepts the raw
value from the widget and returns the converted value. For example, a
FloatField will turn the data into a Python <code class="docutils literal"><span class="pre">float</span></code> or raise a
<code class="docutils literal"><span class="pre">ValidationError</span></code>.</p>
</li>
<li><p class="first">The <code class="docutils literal"><span class="pre">validate()</span></code> method on a Field handles field-specific validation
that is not suitable for a validator, It takes a value that has been
coerced to correct datatype and raises <code class="docutils literal"><span class="pre">ValidationError</span></code> on any error.
This method does not return anything and shouldn&#8217;t alter the value. You
should override it to handle validation logic that you can&#8217;t or don&#8217;t
want to put in a validator.</p>
</li>
<li><p class="first">The <code class="docutils literal"><span class="pre">run_validators()</span></code> method on a Field runs all of the field&#8217;s
validators and aggregates all the errors into a single
<code class="docutils literal"><span class="pre">ValidationError</span></code>. You shouldn&#8217;t need to override this method.</p>
</li>
<li><p class="first">The <code class="docutils literal"><span class="pre">clean()</span></code> method on a Field subclass. This is responsible for
running <code class="docutils literal"><span class="pre">to_python</span></code>, <code class="docutils literal"><span class="pre">validate</span></code> and <code class="docutils literal"><span class="pre">run_validators</span></code> in the correct
order and propagating their errors. If, at any time, any of the methods
raise <code class="docutils literal"><span class="pre">ValidationError</span></code>, the validation stops and that error is raised.
This method returns the clean data, which is then inserted into the
<code class="docutils literal"><span class="pre">cleaned_data</span></code> dictionary of the form.</p>
</li>
<li><p class="first">The <code class="docutils literal"><span class="pre">clean_&lt;fieldname&gt;()</span></code> method in a form subclass &#8211; where
<code class="docutils literal"><span class="pre">&lt;fieldname&gt;</span></code> is replaced with the name of the form field attribute.
This method does any cleaning that is specific to that particular
attribute, unrelated to the type of field that it is. This method is not
passed any parameters. You will need to look up the value of the field
in <code class="docutils literal"><span class="pre">self.cleaned_data</span></code> and remember that it will be a Python object
at this point, not the original string submitted in the form (it will be
in <code class="docutils literal"><span class="pre">cleaned_data</span></code> because the general field <code class="docutils literal"><span class="pre">clean()</span></code> method, above,
has already cleaned the data once).</p>
<p>For example, if you wanted to validate that the contents of a
<code class="docutils literal"><span class="pre">CharField</span></code> called <code class="docutils literal"><span class="pre">serialnumber</span></code> was unique,
<code class="docutils literal"><span class="pre">clean_serialnumber()</span></code> would be the right place to do this. You don&#8217;t
need a specific field (it&#8217;s just a <code class="docutils literal"><span class="pre">CharField</span></code>), but you want a
formfield-specific piece of validation and, possibly,
cleaning/normalizing the data.</p>
<p>This method should return the cleaned value obtained from cleaned_data,
regardless of whether it changed anything or not.</p>
</li>
<li><p class="first">The Form subclass&#8217;s <code class="docutils literal"><span class="pre">clean()</span></code> method. This method can perform
any validation that requires access to multiple fields from the form at
once. This is where you might put in things to check that if field <code class="docutils literal"><span class="pre">A</span></code>
is supplied, field <code class="docutils literal"><span class="pre">B</span></code> must contain a valid email address and the
like. The data that this method returns is the final <code class="docutils literal"><span class="pre">cleaned_data</span></code>
attribute for the form, so don&#8217;t forget to return the full list of
cleaned data if you override this method (by default, <code class="docutils literal"><span class="pre">Form.clean()</span></code>
just returns <code class="docutils literal"><span class="pre">self.cleaned_data</span></code>).</p>
<p>Note that any errors raised by your <code class="docutils literal"><span class="pre">Form.clean()</span></code> override will not
be associated with any field in particular. They go into a special
&#8220;field&#8221; (called <code class="docutils literal"><span class="pre">__all__</span></code>), which you can access via the
<code class="docutils literal"><span class="pre">non_field_errors()</span></code> method if you need to. If you want to attach
errors to a specific field in the form, you will need to access the
<code class="docutils literal"><span class="pre">_errors</span></code> attribute on the form, which is <a class="reference internal" href="#described-later">described later</a>.</p>
<p>Also note that there are special considerations when overriding
the <code class="docutils literal"><span class="pre">clean()</span></code> method of a <code class="docutils literal"><span class="pre">ModelForm</span></code> subclass. (see the
<a class="reference internal" href="../../topics/forms/modelforms.html#overriding-modelform-clean-method"><span>ModelForm documentation</span></a> for more information)</p>
</li>
</ul>
<p>These methods are run in the order given above, one field at a time.  That is,
for each field in the form (in the order they are declared in the form
definition), the <code class="docutils literal"><span class="pre">Field.clean()</span></code> method (or its override) is run, then
<code class="docutils literal"><span class="pre">clean_&lt;fieldname&gt;()</span></code>. Finally, once those two methods are run for every
field, the <code class="docutils literal"><span class="pre">Form.clean()</span></code> method, or its override, is executed.</p>
<p>Examples of each of these methods are provided below.</p>
<p>As mentioned, any of these methods can raise a <code class="docutils literal"><span class="pre">ValidationError</span></code>. For any
field, if the <code class="docutils literal"><span class="pre">Field.clean()</span></code> method raises a <code class="docutils literal"><span class="pre">ValidationError</span></code>, any
field-specific cleaning method is not called. However, the cleaning methods
for all remaining fields are still executed.</p>
<p>The <code class="docutils literal"><span class="pre">clean()</span></code> method for the <code class="docutils literal"><span class="pre">Form</span></code> class or subclass is always run. If
that method raises a <code class="docutils literal"><span class="pre">ValidationError</span></code>, <code class="docutils literal"><span class="pre">cleaned_data</span></code> will be an empty
dictionary.</p>
<p>The previous paragraph means that if you are overriding <code class="docutils literal"><span class="pre">Form.clean()</span></code>, you
should iterate through <code class="docutils literal"><span class="pre">self.cleaned_data.items()</span></code>, possibly considering the
<code class="docutils literal"><span class="pre">_errors</span></code> dictionary attribute on the form as well. In this way, you will
already know which fields have passed their individual validation requirements.</p>
<div class="section" id="form-subclasses-and-modifying-field-errors">
<span id="described-later"></span><h2>Form subclasses and modifying field errors<a class="headerlink" href="#form-subclasses-and-modifying-field-errors" title="Permalink to this headline">¶</a></h2>
<p>Sometimes, in a form&#8217;s <code class="docutils literal"><span class="pre">clean()</span></code> method, you will want to add an error
message to a particular field in the form. This won&#8217;t always be appropriate
and the more typical situation is to raise a <code class="docutils literal"><span class="pre">ValidationError</span></code> from
<code class="docutils literal"><span class="pre">Form.clean()</span></code>, which is turned into a form-wide error that is available
through the <code class="docutils literal"><span class="pre">Form.non_field_errors()</span></code> method.</p>
<p>When you really do need to attach the error to a particular field, you should
store (or amend) a key in the <code class="docutils literal"><span class="pre">Form._errors</span></code> attribute. This attribute is an
instance of a <code class="docutils literal"><span class="pre">django.forms.util.ErrorDict</span></code> class. Essentially, though, it&#8217;s
just a dictionary. There is a key in the dictionary for each field in the form
that has an error. Each value in the dictionary is a
<code class="docutils literal"><span class="pre">django.forms.util.ErrorList</span></code> instance, which is a list that knows how to
display itself in different ways. So you can treat <code class="docutils literal"><span class="pre">_errors</span></code> as a dictionary
mapping field names to lists.</p>
<p>If you want to add a new error to a particular field, you should check whether
the key already exists in <code class="docutils literal"><span class="pre">self._errors</span></code> or not. If not, create a new entry
for the given key, holding an empty <code class="docutils literal"><span class="pre">ErrorList</span></code> instance. In either case,
you can then append your error message to the list for the field name in
question and it will be displayed when the form is displayed.</p>
<p>There is an example of modifying <code class="docutils literal"><span class="pre">self._errors</span></code> in the following section.</p>
<div class="admonition-what-s-in-a-name admonition">
<p class="first admonition-title">What&#8217;s in a name?</p>
<p>You may be wondering why is this attribute called <code class="docutils literal"><span class="pre">_errors</span></code> and not
<code class="docutils literal"><span class="pre">errors</span></code>. Normal Python practice is to prefix a name with an underscore
if it&#8217;s not for external usage. In this case, you are subclassing the
<code class="docutils literal"><span class="pre">Form</span></code> class, so you are essentially writing new internals. In effect,
you are given permission to access some of the internals of <code class="docutils literal"><span class="pre">Form</span></code>.</p>
<p>Of course, any code outside your form should never access <code class="docutils literal"><span class="pre">_errors</span></code>
directly. The data is available to external code through the <code class="docutils literal"><span class="pre">errors</span></code>
property, which populates <code class="docutils literal"><span class="pre">_errors</span></code> before returning it).</p>
<p class="last">Another reason is purely historical: the attribute has been called
<code class="docutils literal"><span class="pre">_errors</span></code> since the early days of the forms module and changing it now
(particularly since <code class="docutils literal"><span class="pre">errors</span></code> is used for the read-only property name)
would be inconvenient for a number of reasons. You can use whichever
explanation makes you feel more comfortable. The result is the same.</p>
</div>
</div>
<div class="section" id="using-validation-in-practice">
<h2>Using validation in practice<a class="headerlink" href="#using-validation-in-practice" title="Permalink to this headline">¶</a></h2>
<p>The previous sections explained how validation works in general for forms.
Since it can sometimes be easier to put things into place by seeing each
feature in use, here are a series of small examples that use each of the
previous features.</p>
<div class="section" id="using-validators">
<span id="validators"></span><h3>Using validators<a class="headerlink" href="#using-validators" title="Permalink to this headline">¶</a></h3>
<p>Django&#8217;s form (and model) fields support use of simple utility functions and
classes known as validators. These can be passed to a field&#8217;s constructor, via
the field&#8217;s <code class="docutils literal"><span class="pre">validators</span></code> argument, or defined on the Field class itself with
the <code class="docutils literal"><span class="pre">default_validators</span></code> attribute.</p>
<p>Simple validators can be used to validate values inside the field, let&#8217;s have
a look at Django&#8217;s <code class="docutils literal"><span class="pre">EmailField</span></code>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">EmailField</span><span class="p">(</span><span class="n">CharField</span><span class="p">):</span>
    <span class="n">default_error_messages</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s">&#39;invalid&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Enter a valid email address.&#39;</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">default_validators</span> <span class="o">=</span> <span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">validate_email</span><span class="p">]</span>
</pre></div>
</div>
<p>As you can see, <code class="docutils literal"><span class="pre">EmailField</span></code> is just a <code class="docutils literal"><span class="pre">CharField</span></code> with customized error
message and a validator that validates email addresses. This can also be done
on field definition so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">email</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">EmailField</span><span class="p">()</span>
</pre></div>
</div>
<p>is equivalent to:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">email</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">validators</span><span class="o">=</span><span class="p">[</span><span class="n">validators</span><span class="o">.</span><span class="n">validate_email</span><span class="p">],</span>
        <span class="n">error_messages</span><span class="o">=</span><span class="p">{</span><span class="s">&#39;invalid&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">(</span><span class="s">&#39;Enter a valid email address.&#39;</span><span class="p">)})</span>
</pre></div>
</div>
</div>
<div class="section" id="form-field-default-cleaning">
<h3>Form field default cleaning<a class="headerlink" href="#form-field-default-cleaning" title="Permalink to this headline">¶</a></h3>
<p>Let&#8217;s firstly create a custom form field that validates its input is a string
containing comma-separated email addresses. The full class looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">django</span> <span class="kn">import</span> <span class="n">forms</span>
<span class="kn">from</span> <span class="nn">django.core.validators</span> <span class="kn">import</span> <span class="n">validate_email</span>

<span class="k">class</span> <span class="nc">MultiEmailField</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Field</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">to_python</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s">&quot;Normalize data to a list of strings.&quot;</span>

        <span class="c"># Return an empty list if no input was given.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&#39;,&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="s">&quot;Check if value consists only of valid emails.&quot;</span>

        <span class="c"># Use the parent&#39;s handling of required fields, etc.</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">MultiEmailField</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">email</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">validate_email</span><span class="p">(</span><span class="n">email</span><span class="p">)</span>
</pre></div>
</div>
<p>Every form that uses this field will have these methods run before anything
else can be done with the field&#8217;s data. This is cleaning that is specific to
this type of field, regardless of how it is subsequently used.</p>
<p>Let&#8217;s create a simple <code class="docutils literal"><span class="pre">ContactForm</span></code> to demonstrate how you&#8217;d use this
field:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ContactForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
    <span class="n">message</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">CharField</span><span class="p">()</span>
    <span class="n">sender</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">EmailField</span><span class="p">()</span>
    <span class="n">recipients</span> <span class="o">=</span> <span class="n">MultiEmailField</span><span class="p">()</span>
    <span class="n">cc_myself</span> <span class="o">=</span> <span class="n">forms</span><span class="o">.</span><span class="n">BooleanField</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</pre></div>
</div>
<p>Simply use <code class="docutils literal"><span class="pre">MultiEmailField</span></code> like any other form field. When the
<code class="docutils literal"><span class="pre">is_valid()</span></code> method is called on the form, the <code class="docutils literal"><span class="pre">MultiEmailField.clean()</span></code>
method will be run as part of the cleaning process and it will, in turn, call
the custom <code class="docutils literal"><span class="pre">to_python()</span></code> and <code class="docutils literal"><span class="pre">validate()</span></code> methods.</p>
</div>
<div class="section" id="cleaning-a-specific-field-attribute">
<h3>Cleaning a specific field attribute<a class="headerlink" href="#cleaning-a-specific-field-attribute" title="Permalink to this headline">¶</a></h3>
<p>Continuing on from the previous example, suppose that in our <code class="docutils literal"><span class="pre">ContactForm</span></code>,
we want to make sure that the <code class="docutils literal"><span class="pre">recipients</span></code> field always contains the address
<code class="docutils literal"><span class="pre">&quot;fred&#64;example.com&quot;</span></code>. This is validation that is specific to our form, so we
don&#8217;t want to put it into the general <code class="docutils literal"><span class="pre">MultiEmailField</span></code> class. Instead, we
write a cleaning method that operates on the <code class="docutils literal"><span class="pre">recipients</span></code> field, like so:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ContactForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="c"># Everything as before.</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">clean_recipients</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cleaned_data</span><span class="p">[</span><span class="s">&#39;recipients&#39;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s">&quot;fred@example.com&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;You have forgotten about Fred!&quot;</span><span class="p">)</span>

        <span class="c"># Always return the cleaned data, whether you have changed it or</span>
        <span class="c"># not.</span>
        <span class="k">return</span> <span class="n">data</span>
</pre></div>
</div>
</div>
<div class="section" id="cleaning-and-validating-fields-that-depend-on-each-other">
<h3>Cleaning and validating fields that depend on each other<a class="headerlink" href="#cleaning-and-validating-fields-that-depend-on-each-other" title="Permalink to this headline">¶</a></h3>
<p>Suppose we add another requirement to our contact form: if the <code class="docutils literal"><span class="pre">cc_myself</span></code>
field is <code class="docutils literal"><span class="pre">True</span></code>, the <code class="docutils literal"><span class="pre">subject</span></code> must contain the word <code class="docutils literal"><span class="pre">&quot;help&quot;</span></code>. We are
performing validation on more than one field at a time, so the form&#8217;s
<code class="docutils literal"><span class="pre">clean()</span></code> method is a good spot to do this. Notice that we are talking about
the <code class="docutils literal"><span class="pre">clean()</span></code> method on the form here, whereas earlier we were writing a
<code class="docutils literal"><span class="pre">clean()</span></code> method on a field. It&#8217;s important to keep the field and form
difference clear when working out where to validate things. Fields are single
data points, forms are a collection of fields.</p>
<p>By the time the form&#8217;s <code class="docutils literal"><span class="pre">clean()</span></code> method is called, all the individual field
clean methods will have been run (the previous two sections), so
<code class="docutils literal"><span class="pre">self.cleaned_data</span></code> will be populated with any data that has survived so
far. So you also need to remember to allow for the fact that the fields you
are wanting to validate might not have survived the initial individual field
checks.</p>
<p>There are two ways to report any errors from this step. Probably the most
common method is to display the error at the top of the form. To create such
an error, you can raise a <code class="docutils literal"><span class="pre">ValidationError</span></code> from the <code class="docutils literal"><span class="pre">clean()</span></code> method. For
example:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ContactForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="c"># Everything as before.</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cleaned_data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ContactForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="n">cc_myself</span> <span class="o">=</span> <span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cc_myself&quot;</span><span class="p">)</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;subject&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cc_myself</span> <span class="ow">and</span> <span class="n">subject</span><span class="p">:</span>
            <span class="c"># Only do something if both fields are valid so far.</span>
            <span class="k">if</span> <span class="s">&quot;help&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">forms</span><span class="o">.</span><span class="n">ValidationError</span><span class="p">(</span><span class="s">&quot;Did not send for &#39;help&#39; in &quot;</span>
                        <span class="s">&quot;the subject despite CC&#39;ing yourself.&quot;</span><span class="p">)</span>

        <span class="c"># Always return the full collection of cleaned data.</span>
        <span class="k">return</span> <span class="n">cleaned_data</span>
</pre></div>
</div>
<p>In this code, if the validation error is raised, the form will display an
error message at the top of the form (normally) describing the problem.</p>
<p>Note that the call to <code class="docutils literal"><span class="pre">super(ContactForm,</span> <span class="pre">self).clean()</span></code> in the example code
ensures that any validation logic in parent classes is maintained.</p>
<p>The second approach might involve assigning the error message to one of the
fields. In this case, let&#8217;s assign an error message to both the &#8220;subject&#8221; and
&#8220;cc_myself&#8221; rows in the form display. Be careful when doing this in practice,
since it can lead to confusing form output. We&#8217;re showing what is possible
here and leaving it up to you and your designers to work out what works
effectively in your particular situation. Our new code (replacing the previous
sample) looks like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">class</span> <span class="nc">ContactForm</span><span class="p">(</span><span class="n">forms</span><span class="o">.</span><span class="n">Form</span><span class="p">):</span>
    <span class="c"># Everything as before.</span>
    <span class="o">...</span>

    <span class="k">def</span> <span class="nf">clean</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">cleaned_data</span> <span class="o">=</span> <span class="nb">super</span><span class="p">(</span><span class="n">ContactForm</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">clean</span><span class="p">()</span>
        <span class="n">cc_myself</span> <span class="o">=</span> <span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;cc_myself&quot;</span><span class="p">)</span>
        <span class="n">subject</span> <span class="o">=</span> <span class="n">cleaned_data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;subject&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cc_myself</span> <span class="ow">and</span> <span class="n">subject</span> <span class="ow">and</span> <span class="s">&quot;help&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">subject</span><span class="p">:</span>
            <span class="c"># We know these are not in self._errors now (see discussion</span>
            <span class="c"># below).</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s">u&quot;Must put &#39;help&#39; in subject when cc&#39;ing yourself.&quot;</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="p">[</span><span class="s">&quot;cc_myself&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_class</span><span class="p">([</span><span class="n">msg</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_errors</span><span class="p">[</span><span class="s">&quot;subject&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_class</span><span class="p">([</span><span class="n">msg</span><span class="p">])</span>

            <span class="c"># These fields are no longer valid. Remove them from the</span>
            <span class="c"># cleaned data.</span>
            <span class="k">del</span> <span class="n">cleaned_data</span><span class="p">[</span><span class="s">&quot;cc_myself&quot;</span><span class="p">]</span>
            <span class="k">del</span> <span class="n">cleaned_data</span><span class="p">[</span><span class="s">&quot;subject&quot;</span><span class="p">]</span>

        <span class="c"># Always return the full collection of cleaned data.</span>
        <span class="k">return</span> <span class="n">cleaned_data</span>
</pre></div>
</div>
<p>As you can see, this approach requires a bit more effort, not withstanding the
extra design effort to create a sensible form display. The details are worth
noting, however. Firstly, earlier we mentioned that you might need to check if
the field name keys already exist in the <code class="docutils literal"><span class="pre">_errors</span></code> dictionary. In this case,
since we know the fields exist in <code class="docutils literal"><span class="pre">self.cleaned_data</span></code>, they must have been
valid when cleaned as individual fields, so there will be no corresponding
entries in <code class="docutils literal"><span class="pre">_errors</span></code>.</p>
<p>Secondly, once we have decided that the combined data in the two fields we are
considering aren&#8217;t valid, we must remember to remove them from the
<code class="docutils literal"><span class="pre">cleaned_data</span></code>.</p>
<div class="versionchanged">
</div>
<p>Django used to remove the <code class="docutils literal"><span class="pre">cleaned_data</span></code> attribute entirely if there were
any errors in the form. Since version 1.5, <code class="docutils literal"><span class="pre">cleaned_data</span></code> is present even if
the form doesn&#8217;t validate, but it contains only field values that did
validate.</p>
</div>
</div>
</div>


           </div>
          </div>
	<hr/>
	<div>
		<p>扫码关注，获取更多内容</p>
		<img src="../../../../statics/img/qrcode.jpg" width="100" height="100" />
	</div>
	<!-- duoshuo start -->
	<div class="ds-thread"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"pytabdocs"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = '../../../../statics/js/duoshuo.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] 
			 || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
	</script>
	<!-- duoshuo end -->
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../middleware.html" class="btn btn-neutral float-right" title="Middleware" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="widgets.html" class="btn btn-neutral" title="Widgets" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright Django Software Foundation and contributors.
      Last updated on Oct 24, 2016.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../../',
            VERSION:'1.5',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../../_static/jquery.js"></script>
      <script type="text/javascript" src="../../_static/underscore.js"></script>
      <script type="text/javascript" src="../../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   
  <script type="text/javascript" src="../../../../static/js/global.html" ></script>
  <script type="text/javascript">
        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
        document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F141f4ed9eb11f462fa19fdd960639134' type='text/javascript'%3E%3C/script%3E"));
  </script>
</body>

<!-- Mirrored from docs.pythontab.com/django/django1.5/ref/forms/validation.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 04 Oct 2022 03:53:51 GMT -->
</html>