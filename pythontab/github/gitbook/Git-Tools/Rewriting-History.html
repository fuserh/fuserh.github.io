
<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->

<!-- Mirrored from docs.pythontab.com/github/gitbook/Git-Tools/Rewriting-History.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 04 Oct 2022 03:56:27 GMT -->
<!-- Added by HTTrack --><meta http-equiv="content-type" content="text/html;charset=utf-8" /><!-- /Added by HTTrack -->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>重写历史 &mdash; Git中文手册 0.1 文档</title>
  
  
  
    
  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  
  
   
  <script src="../_static/js/modernizr.min.js"></script>
</head>
<body class="wy-body-for-nav" role="document">
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index-2.html" class="icon icon-home"> Git中文手册
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="https://docs.pythontab.com/github/gitbook/search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../Getting-Started/index.html">起步</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Git-Basics/index.html">Git 基础</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Git-Branching/index.html">Git 分支</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Git-on-the-Server/index.html">服务器上的 Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Distributed-Git/index.html">分布式 Git</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Git 工具</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="Revision-Selection.html">修订版本（Revision）选择</a></li>
<li class="toctree-l2"><a class="reference internal" href="Interactive-Staging.html">交互式暂存</a></li>
<li class="toctree-l2"><a class="reference internal" href="Stashing.html">储藏（Stashing）</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">重写历史</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id2">改变最近一次提交</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">修改多个提交说明</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">重排提交</a></li>
<li class="toctree-l3"><a class="reference internal" href="#squashing">压制(Squashing)提交</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">拆分提交</a></li>
<li class="toctree-l3"><a class="reference internal" href="#filter-branch">核弹级选项: filter-branch</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">从所有提交中删除一个文件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">将一个子目录设置为新的根目录</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id8">全局性地更换电子邮件地址</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="Debugging-with-Git.html">使用 Git 调试</a></li>
<li class="toctree-l2"><a class="reference internal" href="Submodules.html">子模块</a></li>
<li class="toctree-l2"><a class="reference internal" href="Subtree-Merging.html">子树合并</a></li>
<li class="toctree-l2"><a class="reference internal" href="Summary.html">总结</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../Customizing-Git/index.html">自定义 Git</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Git-and-Other-Systems/index.html">Git 与其他系统</a></li>
<li class="toctree-l1"><a class="reference internal" href="../Git-Internals/index.html">Git 内部原理</a></li>
<li class="toctree-l1"><a class="reference internal" href="../commands/index.html">命令索引</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index-2.html">Git中文手册</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index-2.html"> &mdash; Git中文手册 0.1 文档</a> &raquo;</li>
      
          <li><a href="index.html">Git 工具</a> &raquo;</li>
      
    <li>重写历史</li>
      <li class="wy-breadcrumbs-aside">
        
            <a href="../../../index.html" class="fa fa-github"> 在线手册中心</a>
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>重写历史<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<p>很多时候，在 Git 上工作的时候，你也许会由于某种原因想要修订你的提交历史。Git 的一个卓越之处就是它允许你在最后可能的时刻再作决定。你可以在你即将提交暂存区时决定什么文件归入哪一次提交，你可以使用 stash 命令来决定你暂时搁置的工作，你可以重写已经发生的提交以使它们看起来是另外一种样子。这个包括改变提交的次序、改变说明或者修改提交中包含的文件，将提交归并、拆分或者完全删除——这一切在你尚未开始将你的工作和别人共享前都是可以的。</p>
<p>在这一节中，你会学到如何完成这些很有用的任务以使你的提交历史在你将其共享给别人之前变成你想要的样子。</p>
<div class="section" id="id2">
<h2>改变最近一次提交<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<p>改变最近一次提交也许是最常见的重写历史的行为。对于你的最近一次提交，你经常想做两件基本事情::改变提交说明，或者改变你刚刚通过增加，改变，删除而记录的快照。</p>
<p>如果你只想修改最近一次提交说明，这非常简单:</p>
<div class="highlight-python"><div class="highlight"><pre>$ git commit --amend
</pre></div>
</div>
<p>这会把你带入文本编辑器，里面包含了你最近一次提交说明，供你修改。当你保存并退出编辑器，这个编辑器会写入一个新的提交，里面包含了那个说明，并且让它成为你的新的最近一次提交。</p>
<p>如果你完成提交后又想修改被提交的快照，增加或者修改其中的文件，可能因为你最初提交时，忘了添加一个新建的文件，这个过程基本上一样。你通过修改文件然后对其运行git add或对一个已被记录的文件运行git rm，随后的git commit &#8211;amend会获取你当前的暂存区并将它作为新提交对应的快照。</p>
<p>使用这项技术的时候你必须小心，因为修正会改变提交的SHA-1值。这个很像是一次非常小的rebase——不要在你最近一次提交被推送后还去修正它。</p>
</div>
<div class="section" id="id3">
<h2>修改多个提交说明<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h2>
<p>要修改历史中更早的提交，你必须采用更复杂的工具。Git没有一个修改历史的工具，但是你可以使用rebase工具来衍合一系列的提交到它们原来所在的HEAD上而不是移到新的上。依靠这个交互式的rebase工具，你就可以停留在每一次提交后，如果你想修改或改变说明、增加文件或任何其他事情。你可以通过给git rebase增加-i选项来以交互方式地运行rebase。你必须通过告诉命令衍合到哪次提交，来指明你需要重写的提交的回溯深度。</p>
<p>例如，你想修改最近三次的提交说明，或者其中任意一次，你必须给git rebase -i提供一个参数，指明你想要修改的提交的父提交，例如HEAD~2或者HEAD~3。可能记住~3更加容易，因为你想修改最近三次提交；但是请记住你事实上所指的是四次提交之前，即你想修改的提交的父提交:</p>
<div class="highlight-python"><div class="highlight"><pre>$ git rebase -i HEAD~3
</pre></div>
</div>
<p>再次提醒这是一个衍合命令——HEAD~3..HEAD范围内的每一次提交都会被重写，无论你是否修改说明。不要涵盖你已经推送到中心服务器的提交——这么做会使其他开发者产生混乱，因为你提供了同样变更的不同版本。</p>
<p>运行这个命令会为你的文本编辑器提供一个提交列表，看起来像下面这样:</p>
<div class="highlight-python"><div class="highlight"><pre>pick f7f3f6d changed my name a bit
pick 310154e updated README formatting and added blame
pick a5f4a0d added cat-file

# Rebase 710f0f8..a5f4a0d onto 710f0f8
#
# Commands:
#  p, pick = use commit
#  e, edit = use commit, but stop for amending
#  s, squash = use commit, but meld into previous commit
#
# If you remove a line here THAT COMMIT WILL BE LOST.
# However, if you remove everything, the rebase will be aborted.
#
</pre></div>
</div>
<p>很重要的一点是你得注意这些提交的顺序与你通常通过log命令看到的是相反的。如果你运行log，你会看到下面这样的结果:</p>
<div class="highlight-python"><div class="highlight"><pre>$ git log --pretty=format:&quot;%h %s&quot; HEAD~3..HEAD
a5f4a0d added cat-file
310154e updated README formatting and added blame
f7f3f6d changed my name a bit
</pre></div>
</div>
<p>请注意这里的倒序。交互式的rebase给了你一个即将运行的脚本。它会从你在命令行上指明的提交开始(HEAD~3)然后自上至下重播每次提交里引入的变更。它将最早的列在顶上而不是最近的，因为这是第一个需要重播的。</p>
<p>你需要修改这个脚本来让它停留在你想修改的变更上。要做到这一点，你只要将你想修改的每一次提交前面的pick改为edit。例如，只想修改第三次提交说明的话，你就像下面这样修改文件:</p>
<div class="highlight-python"><div class="highlight"><pre>edit f7f3f6d changed my name a bit
pick 310154e updated README formatting and added blame
pick a5f4a0d added cat-file
</pre></div>
</div>
<p>当你保存并退出编辑器，Git会倒回至列表中的最后一次提交，然后把你送到命令行中，同时显示以下信息:</p>
<div class="highlight-python"><div class="highlight"><pre>$ git rebase -i HEAD~3
Stopped at 7482e0d... updated the gemspec to hopefully work better
You can amend the commit now, with

       git commit --amend

Once you’re satisfied with your changes, run

       git rebase --continue
</pre></div>
</div>
<p>这些指示很明确地告诉了你该干什么。输入:</p>
<div class="highlight-python"><div class="highlight"><pre>$ git commit --amend
</pre></div>
</div>
<p>修改提交说明，退出编辑器。然后，运行:</p>
<div class="highlight-python"><div class="highlight"><pre>$ git rebase --continue
</pre></div>
</div>
<p>这个命令会自动应用其他两次提交，你就完成任务了。如果你将更多行的 pick 改为 edit ，你就能对你想修改的提交重复这些步骤。Git每次都会停下，让你修正提交，完成后继续运行。</p>
</div>
<div class="section" id="id4">
<h2>重排提交<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h2>
<p>你也可以使用交互式的衍合来彻底重排或删除提交。如果你想删除&#8221;added cat-file&#8221;这个提交并且修改其他两次提交引入的顺序，你将rebase脚本从这个:</p>
<div class="highlight-python"><div class="highlight"><pre>pick f7f3f6d changed my name a bit
pick 310154e updated README formatting and added blame
pick a5f4a0d added cat-file
</pre></div>
</div>
<p>改为这个:</p>
<div class="highlight-python"><div class="highlight"><pre>pick 310154e updated README formatting and added blame
pick f7f3f6d changed my name a bit
</pre></div>
</div>
<p>当你保存并退出编辑器，Git 将分支倒回至这些提交的父提交，应用310154e，然后f7f3f6d，接着停止。你有效地修改了这些提交的顺序并且彻底删除了&#8221;added cat-file&#8221;这次提交。</p>
</div>
<div class="section" id="squashing">
<h2>压制(Squashing)提交<a class="headerlink" href="#squashing" title="永久链接至标题">¶</a></h2>
<p>交互式的衍合工具还可以将一系列提交压制为单一提交。脚本在 rebase 的信息里放了一些有用的指示:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c">#</span>
<span class="c"># Commands:</span>
<span class="c">#  p, pick = use commit</span>
<span class="c">#  e, edit = use commit, but stop for amending</span>
<span class="c">#  s, squash = use commit, but meld into previous commit</span>
<span class="c">#</span>
<span class="c"># If you remove a line here THAT COMMIT WILL BE LOST.</span>
<span class="c"># However, if you remove everything, the rebase will be aborted.</span>
<span class="c">#</span>
</pre></div>
</div>
<p>如果不用&#8221;pick&#8221;或者&#8221;edit&#8221;，而是指定&#8221;squash&#8221;，Git 会同时应用那个变更和它之前的变更并将提交说明归并。因此，如果你想将这三个提交合并为单一提交，你可以将脚本修改成这样:</p>
<div class="highlight-python"><div class="highlight"><pre>pick f7f3f6d changed my name a bit
squash 310154e updated README formatting and added blame
squash a5f4a0d added cat-file
</pre></div>
</div>
<p>当你保存并退出编辑器，Git 会应用全部三次变更然后将你送回编辑器来归并三次提交说明:</p>
<div class="highlight-python"><div class="highlight"><pre># This is a combination of 3 commits.
# The first commit&#39;s message is:
changed my name a bit

# This is the 2nd commit message:

updated README formatting and added blame

# This is the 3rd commit message:

added cat-file
</pre></div>
</div>
<p>当你保存之后，你就拥有了一个包含前三次提交的全部变更的单一提交。</p>
</div>
<div class="section" id="id5">
<h2>拆分提交<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h2>
<p>拆分提交就是撤销一次提交，然后多次部分地暂存或提交直到结束。例如，假设你想将三次提交中的中间一次拆分。将&#8221;updated README formatting and added blame&#8221;拆分成两次提交::第一次为&#8221;updated README formatting&#8221;，第二次为&#8221;added blame&#8221;。你可以在rebase -i脚本中修改你想拆分的提交前的指令为&#8221;edit&#8221;:</p>
<div class="highlight-python"><div class="highlight"><pre>pick f7f3f6d changed my name a bit
edit 310154e updated README formatting and added blame
pick a5f4a0d added cat-file
</pre></div>
</div>
<p>然后，这个脚本就将你带入命令行，你重置那次提交，提取被重置的变更，从中创建多次提交。当你保存并退出编辑器，Git 倒回到列表中第一次提交的父提交，应用第一次提交（f7f3f6d），应用第二次提交（310154e），然后将你带到控制台。那里你可以用git reset HEAD^对那次提交进行一次混合的重置，这将撤销那次提交并且将修改的文件撤回。此时你可以暂存并提交文件，直到你拥有多次提交，结束后，运行git rebase &#8211;continue:</p>
<div class="highlight-python"><div class="highlight"><pre>$ git reset HEAD^
$ git add README
$ git commit -m &#39;updated README formatting&#39;
$ git add lib/simplegit.rb
$ git commit -m &#39;added blame&#39;
$ git rebase --continue
</pre></div>
</div>
<p>Git在脚本中应用了最后一次提交（a5f4a0d），你的历史看起来就像这样了:</p>
<div class="highlight-python"><div class="highlight"><pre>$ git log -4 --pretty=format:&quot;%h %s&quot;
1c002dd added cat-file
9b29157 added blame
35cfb2b updated README formatting
f3cc40e changed my name a bit
</pre></div>
</div>
<p>再次提醒，这会修改你列表中的提交的 SHA 值，所以请确保这个列表里不包含你已经推送到共享仓库的提交。</p>
</div>
<div class="section" id="filter-branch">
<h2>核弹级选项: filter-branch<a class="headerlink" href="#filter-branch" title="永久链接至标题">¶</a></h2>
<p>如果你想用脚本的方式修改大量的提交，还有一个重写历史的选项可以用——例如，全局性地修改电子邮件地址或者将一个文件从所有提交中删除。这个命令是filter-branch，这个会大面积地修改你的历史，所以你很有可能不该去用它，除非你的项目尚未公开，没有其他人在你准备修改的提交的基础上工作。尽管如此，这个可以非常有用。你会学习一些常见用法，借此对它的能力有所认识。</p>
</div>
<div class="section" id="id6">
<h2>从所有提交中删除一个文件<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h2>
<p>这个经常发生。有些人不经思考使用git add .，意外地提交了一个巨大的二进制文件，你想将它从所有地方删除。也许你不小心提交了一个包含密码的文件，而你想让你的项目开源。filter-branch大概会是你用来清理整个历史的工具。要从整个历史中删除一个名叫password.txt的文件，你可以在filter-branch上使用&#8211;tree-filter选项:</p>
<div class="highlight-python"><div class="highlight"><pre>$ git filter-branch --tree-filter &#39;rm -f passwords.txt&#39; HEAD
Rewrite 6b9b3cf04e7c5686a9cb838c3f36a8cb6a0fc2bd (21/21)
Ref &#39;refs/heads/master&#39; was rewritten
</pre></div>
</div>
<p>&#8211;tree-filter选项会在每次检出项目时先执行指定的命令然后重新提交结果。在这个例子中，你会在所有快照中删除一个名叫 password.txt 的文件，无论它是否存在。如果你想删除所有不小心提交上去的编辑器备份文件，你可以运行类似git filter-branch &#8211;tree-filter &#8216;rm -f *~&#8217; HEAD的命令。</p>
<p>你可以观察到 Git 重写目录树并且提交，然后将分支指针移到末尾。一个比较好的办法是在一个测试分支上做这些然后在你确定产物真的是你所要的之后，再 hard-reset 你的主分支。要在你所有的分支上运行filter-branch的话，你可以传递一个&#8211;all给命令。</p>
</div>
<div class="section" id="id7">
<h2>将一个子目录设置为新的根目录<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h2>
<p>假设你完成了从另外一个代码控制系统的导入工作，得到了一些没有意义的子目录（trunk, tags等等）。如果你想让trunk子目录成为每一次提交的新的项目根目录，filter-branch也可以帮你做到:</p>
<div class="highlight-python"><div class="highlight"><pre>$ git filter-branch --subdirectory-filter trunk HEAD
Rewrite 856f0bf61e41a27326cdae8f09fe708d679f596f (12/12)
Ref &#39;refs/heads/master&#39; was rewritten
</pre></div>
</div>
<p>现在你的项目根目录就是trunk子目录了。Git 会自动地删除不对这个子目录产生影响的提交。</p>
</div>
<div class="section" id="id8">
<h2>全局性地更换电子邮件地址<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<p>另一个常见的案例是你在开始时忘了运行git config来设置你的姓名和电子邮件地址，也许你想开源一个项目，把你所有的工作电子邮件地址修改为个人地址。无论哪种情况你都可以用filter-branch来更换多次提交里的电子邮件地址。你必须小心一些，只改变属于你的电子邮件地址，所以你使用&#8211;commit-filter:</p>
<div class="highlight-python"><div class="highlight"><pre>$ git filter-branch --commit-filter &#39;
       if [ &quot;$GIT_AUTHOR_EMAIL&quot; = &quot;schacon@localhost&quot; ];
       then
               GIT_AUTHOR_NAME=&quot;Scott Chacon&quot;;
               GIT_AUTHOR_EMAIL=&quot;schacon@example.com&quot;;
               git commit-tree &quot;$@&quot;;
       else
               git commit-tree &quot;$@&quot;;
       fi&#39; HEAD
</pre></div>
</div>
<p>这个会遍历并重写所有提交使之拥有你的新地址。因为提交里包含了它们的父提交的SHA-1值，这个命令会修改你的历史中的所有提交，而不仅仅是包含了匹配的电子邮件地址的那些。</p>
</div>
</div>


           </div>
          </div>
	<hr/>
	<div>
		<p>扫码关注，获取更多内容</p>
		<img src="../../../statics/img/qrcode.jpg" width="100" height="100" />
	</div>
	<!-- duoshuo start -->
	<div class="ds-thread"></div>
	<script type="text/javascript">
	var duoshuoQuery = {short_name:"pytabdocs"};
		(function() {
			var ds = document.createElement('script');
			ds.type = 'text/javascript';ds.async = true;
			ds.src = '../../../statics/js/duoshuo.js';
			ds.charset = 'UTF-8';
			(document.getElementsByTagName('head')[0] 
			 || document.getElementsByTagName('body')[0]).appendChild(ds);
		})();
	</script>
	<!-- duoshuo end -->
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="Debugging-with-Git.html" class="btn btn-neutral float-right" title="使用 Git 调试" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="Stashing.html" class="btn btn-neutral" title="储藏（Stashing）" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; 版权所有 2015, nosy.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   
  <script type="text/javascript" src="../../../static/js/global.html" ></script>
  <script type="text/javascript">
        var _bdhmProtocol = (("https:" == document.location.protocol) ? " https://" : " http://");
        document.write(unescape("%3Cscript src='" + _bdhmProtocol + "hm.baidu.com/h.js%3F141f4ed9eb11f462fa19fdd960639134' type='text/javascript'%3E%3C/script%3E"));
  </script>
</body>

<!-- Mirrored from docs.pythontab.com/github/gitbook/Git-Tools/Rewriting-History.html by HTTrack Website Copier/3.x [XR&CO'2014], Tue, 04 Oct 2022 03:56:27 GMT -->
</html>